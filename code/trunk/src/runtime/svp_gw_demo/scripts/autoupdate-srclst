#!/bin/sh

#Default options

root_dir="./"
file_ext="*"
out_file=""
exclude_ext="exclude"

#---

save_old_out=0
diff_with_old=0

#---

root_dir_set=0
wrote_out_once=0

#------------------------------------------------------------------------------
# Shows the help text

show_usage()
{
    echo "USAGE: autoupdate-srclst [options] [ROOT_DIR]"
    echo
    echo "where ROOT_DIR the top directory of the tree to process (default = ./)."
    echo
    echo "and options include:"
    echo "    -o      <file>      Output file (default prints to stdout)."
    echo "    -ext    <extension> Extension of the files to be processed (default = *)."
    echo "    -ex-ext <extension> Extension of the excluded files (default = exclude)."
    echo "    -b                  Create backup of the output file if specified and"
    echo "                        allready  exists."
    echo "    -d                  Create a diff between the backup output file and" 
    echo "                        the new output file if it has been specified and if"
    echo "                        if a backup exists or will be generated using -b."
    echo "    --help              Display available options."
    echo   

    exit $1
}

#------------------------------------------------------------------------------
#Writes a line of text given in the 1st argument to the 
#output file if it has been specified or to the standard outout if not

write_out()
{
    if [ "$out_file" == "" ]
    then
        echo $1
    else
        if [ $wrote_out_once -gt 0 ]
        then
            echo $1 >> $out_file
        else
            echo $1 > $out_file
            wrote_out_once=1
        fi
    fi
}

#------------------------------------------------------------------------------
#Parse command line and setup options

while [ $# -gt 0 ]
do
    case "$1" in
    -o)
        shift
        out_file=$1
        ;;
    -ext)
        shift
        file_ext=$1
        ;;
    -ex-ext)
        shift
        exclude_ext=$1
        ;;
    -b)
        save_old_out=1
        ;;
    -d)
        diff_with_old=1
        ;;
    --help)
        show_usage 0
        ;;
    *)
        if [ $root_dir_set -eq 0 ]
        then
            root_dir=$1
            root_dir_is_set=1
        else
            echo "Error: Invalid argument '$1'."
            echo

            show_usage 1
        fi
        ;;
    esac
    shift
done

#------------------------------------------------------------------------------
#Backup the old file

if [ "$out_file" != "" ]
then
    if [ $save_old_out -eq 1 ]
    then
        if [ -e $out_file ]
        then
            cp $out_file $out_file~
        fi
    fi
fi

#------------------------------------------------------------------------------
#Write initial info to the output.

write_out  "#Source files list for directory tree '$root_dir'"
write_out  "#Auto-generated by 'autoupdatesrclst' script ver 1.0"
write_out  

#------------------------------------------------------------------------------
#Main operation

files=`find $root_dir -type f -name "*.$file_ext" | grep -v -e ".\.$exclude_ext\.."`
    
for f in $files
do
    write_out $f 
done   

write_out

#------------------------------------------------------------------------------
#Create diff with old if requested

if [ "$out_file" == "" ]; then diff_with_old=0; fi
if [ ! -e $out_file    ]; then diff_with_old=0; fi
if [ ! -e $out_file~   ]; then diff_with_old=0; fi

if [ $diff_with_old -eq 1 ]
then
    diff -b -B $out_file $out_file~ > $out_file.diff
fi

#------------------------------------------------------------------------------
#------------------------------------------------------------------------------

